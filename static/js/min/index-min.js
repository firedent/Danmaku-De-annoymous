function bind(e,t,n){var r=document.querySelectorAll(e);if(r)for(var a=0;a<r.length;a++)r[a].addEventListener(t,n)}function show(e){var t=document.getElementById(e);t.style.display="",t.scrollIntoView()}function hide(e){document.getElementById(e).style.display="none"}function disable(e){document.getElementById(e).disabled=!0}function enable(e){document.getElementById(e).disabled=!1}function getComment(e){var t=new XMLHttpRequest;t.open("GET","https://danmu.fuckbilibili.com/"+e+".xml",!0),show("loader"),disable("getComment"),t.onload=function(){if(hide("loader"),t.status>=200&&t.status<400){disable("vurl");var e=new DOMParser,n=e.parseFromString(t.responseText,"text/xml");window.commentElements=n.getElementsByTagName("d"),show("step2")}else enable("getComment"),$("#vurl").value="读取弹幕失败"},t.onerror=function(){enable("getComment"),hide("loader"),$("#vurl").value="读取弹幕失败"},t.send()}function cm_tmpl(e){var t=e.childNodes[0].nodeValue.replace(/"/g,"&quot;"),n=t;t.length>20&&(n=t.substr(0,20));var r=e.getAttribute("p").split(","),a=parseInt(r[0]),l=r[6],s=parseInt(a/60)%60,o=s.toString();minuteslength=o.length,minuteslength<=1&&(o="0"+o);var i=a%60,u=i.toString();secondslength=u.length,secondslength<=1&&(u="0"+u);var d='<tr><td class="mdl-data-table__cell--non-numeric" title="'+t+'">'+n+"</td><td>"+o+":"+u+'</td>                 <td><a id="cmid_'+l+'" style="color: #ff4081" href="javascript:;" class="cm-view-btn" onclick="getUser(\''+l+"')\">爆他菊花</a></td></tr>";return d}function getUser(e){for(var t=document.querySelectorAll("#cmid_"+e),n=0;n<t.length;n++)t[n].style="color: #3e3e3e",t[n].innerHTML="正在解析";var r=new XMLHttpRequest;r.open("GET","//api.fuckbilibili.com/uidhash.php?hash="+e,!0),r.onload=function(){if(r.status>=200&&r.status<400){var e=JSON.parse(r.responseText);if(e.status){var n=e.data[0].id;window["displayName_"+n]=function(e){for(var r=e.card.name,a=0;a<t.length;a++)t[a].onclick=function(){},t[a].setAttribute("target","_blank"),t[a].style="",t[a].href="http://space.bilibili.com/"+n,t[a].innerHTML=r};var a=document.createElement("script");a.setAttribute("type","text/javascript"),a.setAttribute("charset","utf-8"),a.setAttribute("src","https://account.bilibili.com/api/member/getCardByMid?mid="+n+"&type=jsonp&callback=displayName_"+n),document.body.appendChild(a)}else{alert("用户不存在，这条弹幕是非会员弹幕，也可能是此用户被徐特首删了");for(var l=0;l<t.length;l++)t[l].innerHTML="用户不存在",t[l].onclick="javascript:void(0);",t[l].href="javascript:void(0);"}}else{alert("读取用户失败，服务器错误");for(var l=0;l<t.length;l++)t[l].innerHTML="解析失败"}},r.onerror=function(){alert("读取用户失败，网络错误"),t.innerHTML="网络错误"},r.send()}function getComment2(e){var t=new XMLHttpRequest;t.open("GET","https://danmu.fuckbilibili.com/"+e+".xml",!0),show("loader2"),disable("getComment2"),t.onload=function(){if(hide("loader2"),t.status>=200&&t.status<400){disable("vurl2");var e=new DOMParser,n=e.parseFromString(t.responseText,"text/xml");window.commentElements2=n.getElementsByTagName("d"),show("step2.2")}else enable("getComment2"),$("#vurl1").value="读取弹幕失败"},t.onerror=function(){enable("getComment2"),hide("loader2"),$("#vurl1").value="读取弹幕失败"},t.send()}function cm_tmpl2(e){var t=e.childNodes[0].nodeValue.replace(/"/g,"&quot;"),n=t;t.length>20&&(n=t.substr(0,20));var r=e.getAttribute("p").split(","),a=parseInt(r[0]),l=parseInt(a/60),s=l.toString();minuteslength=s.length,minuteslength<=1&&(s="0"+s);var o=a%60,i=o.toString();secondslength=i.length,secondslength<=1&&(i="0"+i);var u='<tr><td class="mdl-data-table__cell--non-numeric" title="'+t+'">'+n+"</td>                 <td>"+s+":"+i+"</td></tr>";return u}var $=function(e){var t=document.querySelectorAll(e);return t?1==t.length?t[0]:t:void 0};bind("#frm-vurl","submit",function(e){e.preventDefault&&e.preventDefault();var t=/\/video\/av(\d+)(\/index.html|\/index_(\d+).html)?/,n=$("#vurl").value,r=n.match(t);if(!r||!r[1])return $("#vurl").value="无效的视频地址",!1;var a=r[1],l=r[3]||1,s=new XMLHttpRequest;return s.open("GET",apiBase+"cid/"+a+"/"+l,!0),disable("getComment"),show("loader"),s.onload=function(){if(enable("getComment"),hide("loader"),s.status>=200&&s.status<400){var e=JSON.parse(s.responseText);0==e.error?(window.lastCID=e.cid,getComment(e.cid)):$("#vurl").value="请求错误"}else $("#vurl").value="服务器错误"},s.onerror=function(){enable("getComment"),hide("loader"),$("#vurl").value="服务器错误"},s.send(),!1}),bind("#frm-searchcm","submit",function(e){e.preventDefault&&e.preventDefault();var t=$("#cmsearch").value;if(!t)return!1;disable("searchComment"),show("loader");for(var n="",r=0;r<commentElements.length;r++){var a=commentElements[r].childNodes[0];if(a){var l=a.nodeValue;l&&l.indexOf(t)>-1&&(n+=cm_tmpl(commentElements[r]))}}return(!n||n.length<1)&&(n="<tr><td>没有找到任何弹幕，请尝试变更关键词</td></tr>"),$("#cmList").innerHTML=n,enable("searchComment"),hide("loader"),show("step3"),!1}),bind("#frm-vurl2","submit",function(e){e.preventDefault&&e.preventDefault();var t=/\/video\/av(\d+)(\/index.html|\/index_(\d+).html)?/,n=$("#vurl2").value,r=n.match(t);if(!r||!r[1])return $("#vurl2").value="无效的视频地址",!1;var a=r[1],l=r[3]||1,s=new XMLHttpRequest;return s.open("GET",apiBase+"cid/"+a+"/"+l,!0),disable("getComment2"),show("loader2"),s.onload=function(){if(enable("getComment2"),hide("loader2"),s.status>=200&&s.status<400){var e=JSON.parse(s.responseText);0==e.error?getComment2(e.cid):$("#vurl2").value="请求错误"}else $("#vurl2").value="服务器错误"},s.onerror=function(){enable("getComment2"),hide("loader2"),$("#vurl2").value="服务器错误"},s.send(),!1}),bind("#frm-searchus","submit",function(e){e.preventDefault&&e.preventDefault();var t=$("#ussearch").value;if(!t)return!1;disable("searchUser"),show("loader2");var n="";window.finduser=function(e){if(e=e.cards[t],null===e)return $("#ussearch").value="未找到此用户",hide("loader2"),enable("searchUser"),!1;var r=e.mid,a=new XMLHttpRequest;a.open("GET","//api.fuckbilibili.com/uidhash.php?uid="+r,!0),a.onload=function(){if(enable("searchUser"),hide("loader2"),a.status>=200&&a.status<400){show("step2.3");var e=JSON.parse(a.responseText);if(e.status){for(var t=e.data,r=0;r<commentElements2.length;r++){var l=commentElements2[r].getAttribute("p").split(",")[6];l&&l.indexOf(t)>-1&&(n+=cm_tmpl2(commentElements2[r]))}(!n||n.length<1)&&(n="<tr><td>没有找到任何弹幕，请尝试变更用户</td></tr>"),$("#cmList2").innerHTML=n}else $("#ussearch").value="读取用户失败，请求错误"}else $("#ussearch").value="读取用户失败，服务器错误"},a.onerror=function(){alert("读取用户失败，网络错误")},a.send()};var r=document.createElement("script");return r.setAttribute("type","text/javascript"),r.setAttribute("charset","utf-8"),r.setAttribute("src","https://account.bilibili.com/api/member/GetInfoByName?uname="+t+"&type=jsonp&callback=finduser"),document.body.appendChild(r),!1});
